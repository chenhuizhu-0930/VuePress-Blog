(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{362:function(e,a,t){"use strict";t.r(a);var s=t(14),r=Object(s.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("①Dynamics 发出同步请求 → ②③先去 Azure AD，用 Entra ID App 的身份拿到 Exchange Online 的 OAuth 令牌 → ④拿令牌调用 Exchange Web Services → 完成邮件/日历/任务的收发与同步。")]),e._v(" "),a("p",[e._v("一句话总结，通过Entra ID App让 Azure AD 认可 Dynamics op版的身份，从而允许它访问 Exchange Online")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/chenhuizhu-0930/picx-images-hosting/master/202508151125841.png",alt:""}})]),e._v(" "),a("hr"),e._v(" "),a("h3",{attrs:{id:"_0-前提"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-前提"}},[e._v("#")]),e._v(" 0. 前提")]),e._v(" "),a("p",[e._v("Dynamics CRM的op服务器使用Graph Powershell（微软已于2024.3.31弃用了MSOnline PowerShell模块）")]),e._v(" "),a("h3",{attrs:{id:"_1-生成并安装证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-生成并安装证书"}},[e._v("#")]),e._v(" 1. 生成并安装证书")]),e._v(" "),a("h4",{attrs:{id:"_1-1-生成证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-生成证书"}},[e._v("#")]),e._v(" 1.1 生成证书")]),e._v(" "),a("p",[e._v("生成证书后会得到下列参数，在后续步骤3.1中使用：")]),e._v(" "),a("p",[a("strong",[a("code",[e._v("$privateKeyPassword")])])]),e._v(" "),a("ul",[a("li",[e._v("证书私钥的密码（"),a("code",[e._v("SecureString")]),e._v(" 类型）。")])]),e._v(" "),a("p",[a("strong",[a("code",[e._v("$pfxFilePath")])])]),e._v(" "),a("ul",[a("li",[e._v("PFX 文件路径（包含证书和私钥的文件）。")])]),e._v(" "),a("h4",{attrs:{id:"_1-2-安装证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-安装证书"}},[e._v("#")]),e._v(" 1.2 安装证书")]),e._v(" "),a("p",[a("strong",[e._v("目的")]),e._v("：把 PFX 证书导入到服务器证书存储 + 给 CRM 异步服务账号授予私钥读取权限 + 在 CRM 配置数据库里登记这个证书（类型为 "),a("code",[e._v("S2STokenIssuer")]),e._v("）")]),e._v(" "),a("ol",[a("li",[a("p",[a("strong",[e._v("以管理员身份，在运行部署工具服务器角色的 Microsoft Dynamics 365 Server 上，启动适用于 Windows PowerShell 的 Azure Active Directory 模块。")])]),e._v(" "),a("ul",[a("li",[e._v("**目的：**用于后续3.1运行的 "),a("code",[e._v("ConfigureCrmServerSideSync.ps1")]),e._v("脚本中和AAD通信")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("将PowerShell当前目录更改为 "),a("code",[e._v("CertificateReconfiguration.ps1")]),e._v(" 文件所在的位置（默认为 C:\\Program Files\\Microsoft Dynamics CRM\\Tools）。")])]),e._v(" "),a("div",{staticClass:"language-powershell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[e._v("cd "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"C:\\Program Files\\Microsoft Dynamics CRM\\Tools"')]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("替换下面命令中的：")])]),e._v(" "),a("p",[e._v("（1）certificateFile 为【PFX 证书文件的完整路径】；")]),e._v(" "),a("p",[e._v("（2）personal_certfile_password为【导出 PFX 时设置的私钥密码】；")]),e._v(" "),a("p",[e._v("（3）contoso\\CRMAsyncService为【运行 Dynamics 365 异步处理服务（Async Service）的域账号】")]),e._v(" "),a("div",{staticClass:"language-powershell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$CertificateScriptWithCommand")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('".\\CertificateReconfiguration.ps1 -certificateFile c:\\Personalcertfile.pfx -password personal_certfile_password -updateCrm -certificateType S2STokenIssuer -serviceAccount contoso\\CRMAsyncService -storeFindType FindBySubjectDistinguishedName"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("Invoke-Expression")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("command "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$CertificateScriptWithCommand")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])])])]),e._v(" "),a("h3",{attrs:{id:"_2-注册应用程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-注册应用程序"}},[e._v("#")]),e._v(" 2. 注册应用程序")]),e._v(" "),a("p",[e._v("用于 Dynamics 与 Exchange Online 之间的通信。注册应用程序会在应用与Microsoft 标识平台之间建立信任关系。 信任是单向的：你的应用信任Microsoft 标识平台，而不是相反。 创建后，应用程序对象不能在不同的租户之间移动。")]),e._v(" "),a("p",[e._v("注意：注册应用程序需要用和1中远程登录crm服务器安装证书的同一个身份。")]),e._v(" "),a("h4",{attrs:{id:"_2-1-注册应用程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-注册应用程序"}},[e._v("#")]),e._v(" 2.1 注册应用程序")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("路径")]),e._v("：Azure Portal > Microsoft Entra ID > App registrations > New registration")])]),e._v(" "),a("h4",{attrs:{id:"_2-2-配置平台设置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-配置平台设置"}},[e._v("#")]),e._v(" 2.2 配置平台设置")]),e._v(" "),a("ul",[a("li",[a("p",[a("strong",[e._v("目的")]),e._v("：输入应用的 "),a("strong",[e._v("重定向 URI")]),e._v(" 。 此 URI 是 Microsoft 标识平台重定向用户客户端并在身份验证后发送安全令牌的位置。")])]),e._v(" "),a("li",[a("p",[a("strong",[e._v("路径")]),e._v("：注册完成后，Microsoft Entra 管理中心将显示应用注册的“"),a("strong",[e._v("概述")]),e._v("”窗格。在该页面的Manage > Authentication(Preview)中，点击Add Redirect URI")])])]),e._v(" "),a("h4",{attrs:{id:"_2-3-添加凭据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-添加凭据"}},[e._v("#")]),e._v(" 2.3 添加凭据")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("目的")]),e._v("：凭据由访问 Web API 的 "),a("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/entra/identity-platform/msal-client-applications",target:"_blank",rel:"noopener noreferrer"}},[e._v("机密客户端应用程序"),a("OutboundLink")],1),e._v(" 使用。 机密客户端的示例包括 Web 应用、其他 Web API 或服务类型和守护程序类型应用程序。 凭据允许应用程序以自身身份进行身份验证，无需用户在运行时进行交互。")]),e._v(" "),a("li",[a("strong",[e._v("路径")]),e._v("：该页面的Manage > Certificates&secrets > New client secret\n"),a("ul",[a("li",[e._v("客户端机密生存期限制为两年 (24 个月) 或更短。 不能指定超过 24 个月的自定义生存期。")]),e._v(" "),a("li",[e._v("Microsoft建议将过期值设置为小于 12 个月。")]),e._v(" "),a("li",[a("em",[e._v("记录要在")]),e._v(" 客户端应用程序代码中使用的机密值。 离开此页面后 "),a("em",[e._v("，永远不会再次显示")]),e._v(" 此机密值。")])])])]),e._v(" "),a("h4",{attrs:{id:"_2-4-向新应用添加并授予以下api权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-向新应用添加并授予以下api权限"}},[e._v("#")]),e._v(" 2.4 向新应用添加并授予以下API权限")]),e._v(" "),a("p",[e._v("Application.ReadWrite.All、Orgaization.Read.All、User.Read")]),e._v(" "),a("ul",[a("li",[a("mark",[a("strong",[e._v("目的")]),e._v("：")])])]),e._v(" "),a("h5",{attrs:{id:"_2-4-1-添加权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-添加权限"}},[e._v("#")]),e._v(" 2.4.1 添加权限")]),e._v(" "),a("p",[e._v("**路径：**该页面的Manage > API permissions > Add a permission")]),e._v(" "),a("h5",{attrs:{id:"_2-4-2-由管理员授予权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-由管理员授予权限"}},[e._v("#")]),e._v(" 2.4.2 由管理员授予权限")]),e._v(" "),a("h3",{attrs:{id:"_3-在-dynamics-365-中配置-s2s-身份验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-在-dynamics-365-中配置-s2s-身份验证"}},[e._v("#")]),e._v(" 3. 在 Dynamics 365 中配置 S2S 身份验证")]),e._v(" "),a("p",[e._v("在Dynamics 365 CRM的应用服务器上，以管理员身份启动 "),a("strong",[e._v("Azure Active Directory PowerShell 模块")])]),e._v(" "),a("h4",{attrs:{id:"_3-1-运行-powershell-脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-运行-powershell-脚本"}},[e._v("#")]),e._v(" 3.1 "),a("strong",[e._v("运行 PowerShell 脚本")])]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("目的")]),e._v("：运行"),a("code",[e._v("CertificateReconfiguration.ps1")]),e._v("脚本，这一步会把 S2S 身份信息写入 Dynamics 配置数据库。")])]),e._v(" "),a("div",{staticClass:"language-powershell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ConfigureCrmServerSideSyncWithCommand")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("\".\\ConfigureCrmServerSideSync.ps1 -privateKeyPassword (ConvertTo- SecureString 'personal_certfile_password' -AsPlainText -Force) -pfxFilePath c:\\Personalcertfile.pfx -organizationName organization_name -microsoftEntraIdTenantIdOrDomainName microsoft_entraid_tenantid_or_domain_name -ClientID app_id_from_step3 -ClientSecret -client_secret\"")]),e._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("Invoke-Expression")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("command "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ConfigureCrmServerSideSyncWithCommand")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("带下划线的占位符替换成下列实际值填入：")]),e._v(" "),a("p",[e._v("(1) 在步骤1中得到的：")]),e._v(" "),a("ul",[a("li",[a("strong",[a("code",[e._v("$privateKeyPassword")])]),e._v("【证书私钥的密码（"),a("code",[e._v("SecureString")]),e._v(" 类型）】")])]),e._v(" "),a("p",[a("strong",[a("code",[e._v("$pfxFilePath")])]),e._v("【PFX 文件路径（包含证书和私钥的文件）】")]),e._v(" "),a("p",[e._v("（2）"),a("strong",[a("code",[e._v("$organizationName")])]),e._v("【CRM组织名称】")]),e._v(" "),a("p",[e._v("（3）步骤2中得到的：")]),e._v(" "),a("ul",[a("li",[a("strong",[a("code",[e._v("$microsoftEntraIdTenantIdOrDomainName")])]),e._v("【Microsoft Entra ID（Azure AD）的租户 ID 或租户主域名比如contoso.onmicrosoft.com】")]),e._v(" "),a("li",[a("strong",[a("code",[e._v("$clientID")])]),e._v("【在 Entra ID 中注册的应用程序 ID（Application ID）】")]),e._v(" "),a("li",[a("strong",[a("code",[e._v("$clientSecret")])]),e._v("【上述应用的客户端密钥（client secret）】")])]),e._v(" "),a("h3",{attrs:{id:"_4-设置-exchange-online-租户-id"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-设置-exchange-online-租户-id"}},[e._v("#")]),e._v(" 4. 设置 Exchange Online 租户 ID")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("在适用于 Windows PowerShell shell Azure Active Directory 模块中，运行下列命令。")]),e._v(" "),a("div",{staticClass:"language-powershell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$CRMContextId")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("Get-MsolCompanyInformation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("ObjectID\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$CRMContextId")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])])]),e._v(" "),a("li",[a("p",[e._v("将显示的 GUID 复制到剪贴板。")])]),e._v(" "),a("li",[a("p",[e._v("通过运行以下命令更新组织的 S2STenantId，其中，OrganizationName 是组织的唯一名称，ExchangeOnlineTenantId 是上一步中检索到的 TenantId。")]),e._v(" "),a("div",{staticClass:"language-powershell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-powershell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$organizationName")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"OrganizationName"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$CRMContextId")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"ExchangeOnlineTenantId"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$orgInfo")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("Get-CrmOrganization")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("Name "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$organizationName")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ID")]),e._v(" = "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$orgInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("id \n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("Set-CrmAdvancedSetting")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ID "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$orgInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("ID "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("configurationEntityName "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Organization"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("setting "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"S2STenantId"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("value "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$CRMContextId")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])])])]),e._v(" "),a("h3",{attrs:{id:"_5-创建电子邮件服务器配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-创建电子邮件服务器配置文件"}},[e._v("#")]),e._v(" 5. "),a("strong",[e._v("创建电子邮件服务器配置文件")])]),e._v(" "),a("ul",[a("li",[e._v("创建 Exchange Online 的 Email Server Profile")]),e._v(" "),a("li",[e._v("指定身份验证类型为 "),a("strong",[e._v("Server-to-Server")])])]),e._v(" "),a("h3",{attrs:{id:"_6-参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-参考链接"}},[e._v("#")]),e._v(" 6. 参考链接")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/dynamics365/customerengagement/on-premises/admin/connect-dynamics-365-on-premises-exchange-online?view=op-9-1#set-up-server-based-authentication-with-microsoft-dynamics-365-and-exchange-online",target:"_blank",rel:"noopener noreferrer"}},[e._v("将 Customer Engagement (on-premises) 连接到 Exchange Online"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"https://learn.microsoft.com/zh-cn/graph/auth-register-app-v2",target:"_blank",rel:"noopener noreferrer"}},[e._v("在EntraID上登录APP"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports}}]);